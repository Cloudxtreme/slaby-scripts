#!/bin/bash

WIN=0

if [ "$1" = "-w" ]; then
	WIN=1
	shift
fi

if [ $# -lt 1 ]; then
	echo $0 '<file.img> [qemu arguments]'
	exit 1
fi

if [ -z "$TMPDIR" ]; then
	TMPDIR=/tmp
fi

FILE=$1
shift

MEM=`grep 'MemTotal:' /proc/meminfo|sed 's/^.*: *\([0-9]*\) *kB$/\1/'`
MEM=$(($MEM/5/1024))

if [ $MEM -lt 100 ]; then
	MEM=100
fi

QEMU_ARGS="-k en-us -smp 2 -m $MEM -usb -usbdevice tablet -hda $FILE"
if [ $WIN = 1 ]; then
	QEMU_ARGS="$QEMU_ARGS -soundhw ac97 -net user,smb=/home/smb,hostfwd=tcp::3389-:3389 -net nic,model=rtl8139 -localtime"
else
	QEMU_ARGS="$QEMU_ARGS -soundhw hda -net user,hostfwd=tcp::2222-:22 -net nic,model=e1000 -serial pty -balloon virtio"
fi

QEMU_RUN="qemu-kvm $QEMU_ARGS $@"
echo $QEMU_RUN

if [ $WIN = 1 ]; then
	exec $QEMU_RUN
else
	SCR=$TMPDIR/qemu.$RANDOM
	rm -f $SCR >/dev/null 2>&1

	$QEMU_RUN 2> >(tee $SCR >&2) &
	QEMU=$!

	FAIL=0
	while ! grep -q 'redirected to' $SCR 2>/dev/null; do
		if [ ! -d "/proc/$QEMU" ]; then
			FAIL=1
			break
		fi
		usleep 100000
	done

	if [ $FAIL = 0 ]; then
		screen `sed -ne '/redirected to / s@.*redirected to \(/dev[^ ]*\).*@\1@ p' $SCR`
	fi

	rm -f $SCR

	wait $QEMU
fi
