#!/bin/bash

REMOTE_REPO=git://git.kernel.org/pub/scm/linux/kernel/git/jirislaby/linux-stable.git

set -e -x

if [ -z "$1" ]; then
	exit 1
fi

if [ "x$COLUMNS" != "x70" ]; then
	echo resize terminal to have 70 colums, git request-pull sucks
	exit 1
fi

RELEASE=$1
RELNO=${RELEASE##*.}
LASTREL=${RELEASE%.[0-9]*}.$(($RELNO-1))
SHA=$2

git tag -u 06B47049 -m "This is the ${RELEASE} stable release" v${RELEASE} $SHA
SHA=`git rev-parse --verify v${RELEASE}^{commit}`
git push korg $SHA:refs/heads/stable-3.12 v${RELEASE}
ATTEMPT=0
while [ $ATTEMPT -lt 30 ]; do
	if [ "x`git ls-remote $REMOTE_REPO v${RELEASE}`" != x ]; then
		break
	fi
	sleep 1
	ATTEMPT=$(($ATTEMPT+1))
done
COLUMNS=70 git request-pull "v$LASTREL" "$REMOTE_REPO" "v$RELEASE"
