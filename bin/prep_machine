#!/bin/bash

set -xxe

if [ -f /etc/os-release ]; then
	. /etc/os-release
else
	eval `grep -Ew 'VERSION|PATCHLEVEL' /etc/SuSE-release|sed 's@ @@g'`
fi

function add_repo() {
	sudo zypper ar -f "$1" 2>/dev/null || true
}

REMOUNT_DEV=0
SCM=0

if ! mount | grep -q 'addr=[^,]*:[^,]*:'; then
	for DEV in `ls -d /sys/class/net/*`; do
		DEV=`basename $DEV`
		sudo ip -6 r flush dev $DEV
		sudo ip -6 a flush dev $DEV
	done
fi
sudo sed -i 's@nameserver.*:@@' /etc/resolv.conf

case "$VERSION" in
	11) case "$PATCHLEVEL" in
		3) add_repo 'http://dist.suse.de/ibs/SUSE:/Tools/SUSE_SLE-11-SP3_Update/SUSE:Tools.repo'
		   add_repo 'http://download.opensuse.org/repositories/devel:/tools:/scm/SLE_11_SP3/devel:tools:scm.repo'
		   add_repo 'http://dist.suse.de/ibs/SUSE:/CA/SLE_11_SP3/SUSE:CA.repo'
		   SCM=1
		;;
	esac
	;;
	11.[34]) add_repo 'http://dist.suse.de/ibs/SUSE:/Tools/SUSE_SLE-11-SP3_Update/SUSE:Tools.repo'
	      add_repo 'http://download.opensuse.org/repositories/devel:/tools:/scm/SLE_11_SP3/devel:tools:scm.repo'
	      add_repo 'http://dist.suse.de/ibs/SUSE:/CA/SLE_11_SP3/SUSE:CA.repo'
	      SCM=1
	;;
	12) add_repo 'http://dist.suse.de/ibs/SUSE:/Tools/SLE_12/SUSE:Tools.repo'
	    add_repo 'http://download.opensuse.org/repositories/devel:/tools:/scm/SLE_12/devel:tools:scm.repo'
	    add_repo 'http://dist.suse.de/ibs/SUSE:/CA/SLE_12/SUSE:CA.repo'
	    REMOUNT_DEV=1
	    SCM=1
	;;
	13.2\ *)
	    REMOUNT_DEV=1
	;;
esac

sudo zypper -v --gpg-auto-import-keys -n in --no-rec \
	ca-certificates-suse cscope quilt \
	osc build gcc git-core make \
	obs-service-download_files obs-service-format_spec_file \
	obs-service-recompress obs-service-set_version \
	obs-service-source_validator obs-service-tar_scm \
	obs-service-verify_file perl-Config-IniFiles perl-File-Which \
	perl-XML-Writer \
	perl-libwww-perl tig || :

sudo zypper -v --gpg-auto-import-keys -n in --no-rec \
	dwarves || :

if [ $REMOUNT_DEV -eq 1 ]; then
	sudo mount -oremount,dev,suid tmpfs /dev/shm
fi

if [ $SCM -eq 1 ]; then
	sudo zypper -v dup --from devel_tools_scm || :
fi
